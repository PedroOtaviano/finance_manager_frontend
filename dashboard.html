<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Finance Manager - Dashboard</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css"
    />
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org/dist/ext/json-enc.js"></script>

    <script>
      function updateBalance() {
        htmx.trigger("#balance", "load");
      }

      window.addEventListener("DOMContentLoaded", () => {
        const token = localStorage.getItem("token");

        // Redireciona se n√£o estiver logado
        if (!token) {
          alert("Voc√™ precisa estar logado para acessar o dashboard.");
          window.location.href = "index.html";
          return;
        }

        // Injeta o token nas requisi√ß√µes HTMX
        document.body.addEventListener("htmx:configRequest", function (event) {
          event.detail.headers["Authorization"] = "Bearer " + token;
        });

        // Dispara manualmente os hx-get ap√≥s garantir que o token foi injetado
        htmx.trigger("#balance", "load");
        htmx.trigger("#trends", "load");
        htmx.trigger("#transactions", "load");
      });

      // Fun√ß√£o de logout
      function logout() {
        localStorage.removeItem("token");
        window.location.href = "index.html";
      }
    </script>

    <style>
      .positive {
        color: green;
        font-weight: bold;
      }
      .negative {
        color: red;
        font-weight: bold;
      }
      .logout {
        position: absolute;
        top: 1rem;
        right: 1rem;
      }
    </style>
  </head>
  <body>
    <main class="container">
      <button class="logout" onclick="logout()">Sair</button>
      <h1>üìä Dashboard Financeiro</h1>

      <!-- Saldo atual -->
      <section>
        <h2>Saldo Atual</h2>
        <div
          id="balance"
          hx-get="http://127.0.0.1:8000/dashboard/summary_html?month=10&year=2025"
          hx-swap="innerHTML"
        >
          Carregando saldo...
        </div>
      </section>

      <!-- Tend√™ncia -->
      <section>
        <h2>Tend√™ncia dos √∫ltimos meses</h2>
        <div
          id="trends"
          hx-get="http://127.0.0.1:8000/dashboard/trends_html?months=6"
          hx-swap="innerHTML"
        >
          Carregando gr√°fico...
        </div>
      </section>

      <!-- Transa√ß√µes -->
      <section>
        <h2>Transa√ß√µes</h2>
        <div
          id="transactions"
          hx-get="http://127.0.0.1:8000/transactions/"
          hx-swap="innerHTML"
        >
          Carregando transa√ß√µes...
        </div>
      </section>

      <!-- Nova transa√ß√£o -->
      <section>
        <h2>Adicionar Transa√ß√£o</h2>
        <form
          hx-post="http://127.0.0.1:8000/transactions/"
          hx-ext="json-enc"
          hx-encoding="json"
          hx-target="#transactions"
          hx-swap="outerHTML"
          hx-on="htmx:afterRequest: updateBalance"
        >
          <select name="category_id" required>
            <option value="1">Sal√°rio</option>
            <option value="2">Aluguel</option>
            <option value="3">Transporte</option>
          </select>

          <select name="type" required>
            <option value="income">Receita</option>
            <option value="expense">Despesa</option>
          </select>

          <input type="number" name="amount" placeholder="Valor" required />

          <input type="date" name="date" required />

          <input type="text" name="note" placeholder="Observa√ß√£o (opcional)" />

          <button type="submit">Adicionar</button>
        </form>
      </section>
    </main>
  </body>
</html>
